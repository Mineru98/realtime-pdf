<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 PDF 뷰어</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #DBE5FA;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background-color: #183994;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-list-section {
            margin: 20px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e1e5e9;
        }

        .room-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .room-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .room-list-item:hover {
            background-color: #e8f0ff;
        }

        .room-info {
            flex: 1;
        }

        .room-name {
            font-weight: bold;
            color: #183994;
            margin-bottom: 5px;
        }

        .room-details {
            font-size: 12px;
            color: #666;
        }

        .room-privacy {
            background-color: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }

        .room-privacy.private {
            background-color: #dc3545;
        }

        .btn-join-room {
            background-color: #208BBF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-join-room:hover {
            background-color: #1a7ab0;
        }

        .no-rooms {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        .room-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .room-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }


        .privacy-radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .password-input-group {
            display: none;
            margin-left: 20px;
        }

        .password-input-group.show {
            display: block;
        }

        .room-input {
            padding: 8px 12px;
            border: 1px solid #c8d4ff;
            border-radius: 4px;
            font-size: 14px;
            width: 150px;
        }

        .room-input.error {
            border-color: #e74c3c;
        }

        .role-selector {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-host {
            background-color: #208BBF;
            color: white;
        }

        .btn-host:hover {
            background-color: #1a7ab0;
        }

        .btn-host.active {
            background-color: #183994;
        }

        .btn-viewer {
            background-color: #208BBF;
            color: white;
        }

        .btn-viewer:hover {
            background-color: #1a7ab0;
        }

        .btn-viewer.active {
            background-color: #183994;
        }

        .upload-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: none;
        }

        .upload-section.show {
            display: block;
        }

        .viewer-section {
            display: flex;
            gap: 20px;
            height: 70vh;
        }

        .pdf-container {
            flex: 1;
            position: relative;
        }

        .pdf-viewer {
            height: 100%;
            border: none;
            width: 100%;
            max-width: none;
            max-height: none;
            transition: height 0.3s ease;
        }

        .chat-section {
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 15px;
            background-color: #183994;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f9fa;
            max-height: calc(70vh - 120px);
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.own {
            background-color: #208BBF;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .chat-message.other {
            background-color: white;
            color: #333;
            border: 1px solid #e1e5e9;
        }

        .chat-message .sender {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .chat-message .content {
            font-size: 14px;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            gap: 10px;
            background: white;
            border-top: 1px solid #e1e5e9;
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #c8d4ff;
            border-radius: 4px;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #208BBF;
        }

        .send-chat-btn {
            padding: 8px 16px;
            background-color: #208BBF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .send-chat-btn:hover {
            background-color: #1a7ab0;
        }

        .pdf-viewer.fullscreen {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            background-color: #000;
        }

        .viewer-section.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            background-color: #000;
            overflow: auto; /* 세로 스크롤 허용 */
        }

        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-size: 16px;
        }

        .fullscreen-btn:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        .status {
            padding: 10px 20px;
            background-color: #f0f4ff;
            border-top: 1px solid #c8d4ff;
            font-size: 14px;
            color: #183994;
        }

        .page-controls {
            padding: 10px 20px;
            background-color: #f0f4ff;
            border-top: 1px solid #c8d4ff;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1001;
        }

        .viewer-section.fullscreen .page-controls,
        .viewer-section.fullscreen .fullscreen-btn {
            display: none;
        }

        .viewer-section.fullscreen .page-info {
            color: white;
        }

        .page-info {
            font-weight: bold;
            color: #183994;
        }

        .hidden {
            display: none !important;
        }

        .drop-zone {
            border: 2px dashed #c8d4ff;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            background-color: #f0f4ff;
            transition: border-color 0.3s;
        }

        .drop-zone.dragover {
            border-color: #208BBF;
            background-color: #e8f0ff;
        }

        .file-input {
            margin: 10px 0;
        }

        #pdfCanvas {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            /* 화질 개선을 위한 CSS */
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            -ms-interpolation-mode: nearest-neighbor;
            image-rendering: pixelated; /* 고화질 유지 */
            /* Canvas 확대 시 선명도 유지 */
            transform: scale(1); /* 기본 스케일 고정 */
        }

        /* 전체 컨테이너 스케일링 방지 */
        .pdf-container {
            transform-origin: top left;
            overflow: auto;
        }

        .viewer-section.fullscreen #pdfCanvas {
            position: absolute !important;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Toast 알림 스타일 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }

        .toast.warning {
            background-color: #ffc107;
            color: #212529;
        }

        .toast.info {
            background-color: #17a2b8;
        }

        .toast-close {
            float: right;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
        }

        .toast-close:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>실시간 PDF 뷰어</h1>
            <div id="initialSection" class="room-section">
                <div class="room-input-group">
                    <label for="roomInput">방 이름:</label>
                    <input type="text" id="roomInput" class="room-input" placeholder="영어/숫자만 입력" maxlength="20">
                    <div class="privacy-radio-group">
                        <label>
                            <input type="radio" name="privacy" value="public" checked> 공개방
                        </label>
                        <label>
                            <input type="radio" name="privacy" value="private"> 비공개방
                        </label>
                    </div>
                    <button id="createRoomBtn" class="btn-host">방 생성</button>
                    <div id="passwordInputGroup" class="password-input-group">
                        <label for="roomPassword">비밀번호:</label>
                        <input type="password" id="roomPassword" class="room-input" placeholder="비밀번호 입력" maxlength="50">
                    </div>
                </div>
                <div id="roomError" class="error-message" style="color: #e74c3c; font-size: 12px; display: none;"></div>
            </div>
            <div id="joinedSection" class="room-section" style="display: none;">
                <div>방: <span id="currentRoomId"></span> | 역할: <span id="currentRole"></span></div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                    <button id="shareRoomBtn" class="btn-viewer" style="font-size: 14px; padding: 6px 12px;">방 링크 공유</button>
                    <button id="leaveRoomBtn" class="btn-viewer">방 나가기</button>
                </div>
            </div>
        </div>

        <!-- 방 목록 섹션 -->
        <div class="room-list-section">
            <div class="room-list-header">
                <h2>방 목록</h2>
                <button id="refreshRoomListBtn" class="btn-viewer" style="font-size: 14px; padding: 6px 12px;">새로고침</button>
            </div>
            <div id="roomListContainer">
                <div class="no-rooms">방 목록을 불러오는 중...</div>
            </div>
        </div>

        <div id="uploadSection" class="upload-section">
            <div class="drop-zone" id="dropZone">
                <p>PDF 파일을 여기에 드래그하거나 클릭해서 선택하세요</p>
                <input type="file" id="fileInput" accept=".pdf" class="file-input">
            </div>
        </div>

        <div id="viewerSection" class="hidden">
            <div class="pdf-container">
                <canvas id="pdfCanvas" class="pdf-viewer"></canvas>
                <button id="fullscreenBtn" class="fullscreen-btn">전체화면</button>
                <div class="page-controls">
                    <button id="prevBtn">이전</button>
                    <span id="pageInfo" class="page-info">페이지 로딩 중...</span>
                    <button id="nextBtn">다음</button>
                </div>
            </div>
            <div class="chat-section">
                <div class="chat-header">
                    <h3>채팅</h3>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" class="chat-input" placeholder="메시지를 입력하세요..." maxlength="200">
                    <button id="sendChatBtn" class="send-chat-btn">전송</button>
                </div>
            </div>
        </div>

        <div id="status" class="status">
            역할을 선택해주세요.
        </div>

    </div>

    <!-- Toast 알림 컨테이너 -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- PDF.js 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- WebSocket 클라이언트 -->
    <script src="js/websocket.js"></script>

    <!-- PDF 뷰어 -->
    <script src="js/viewer.js"></script>

    <script>
        // PDF.js 워커 설정
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let currentRoomId = null;
        let currentRole = null;
        let isFullscreen = false;

        // Toast 알림 함수들
        function showToast(message, type = 'info', duration = 4000) {
            const toastContainer = document.getElementById('toastContainer');

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-close" onclick="this.parentElement.remove()">&times;</span>
                ${message}
            `;

            toastContainer.appendChild(toast);

            // 애니메이션 효과
            setTimeout(() => toast.classList.add('show'), 10);

            // 자동 제거
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // URL 쿼리스트링 파싱 함수
        function getUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const room = urlParams.get('room');
            const pw = urlParams.get('pw');

            return {
                room: room,
                password: pw
            };
        }

        // URL에서 방 정보 제거 (깔끔한 URL 유지)
        function cleanUrl() {
            const url = new URL(window.location);
            url.searchParams.delete('room');
            url.searchParams.delete('pw');
            window.history.replaceState({}, document.title, url.pathname + url.hash);
        }

        // 방 생성
        document.getElementById('createRoomBtn').addEventListener('click', () => {
            createRoom();
        });

        document.getElementById('leaveRoomBtn').addEventListener('click', () => {
            leaveRoom();
        });

        document.getElementById('shareRoomBtn').addEventListener('click', () => {
            shareRoomLink();
        });

        // 방 목록 새로고침
        document.getElementById('refreshRoomListBtn').addEventListener('click', () => {
            loadRoomList();
        });

        // 방 이름 입력 검증
        document.getElementById('roomInput').addEventListener('input', (e) => {
            const value = e.target.value;
            const isValid = /^[a-zA-Z0-9]*$/.test(value);

            e.target.classList.toggle('error', !isValid);
            document.getElementById('roomError').style.display = isValid ? 'none' : 'block';
            document.getElementById('roomError').textContent = isValid ? '' : '영어와 숫자만 입력 가능합니다.';
        });

        // privacy 설정 변경 이벤트
        document.querySelectorAll('input[name="privacy"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const passwordGroup = document.getElementById('passwordInputGroup');
                if (e.target.value === 'private') {
                    passwordGroup.classList.add('show');
                } else {
                    passwordGroup.classList.remove('show');
                    document.getElementById('roomPassword').value = '';
                }
            });
        });

        // Enter 키로 방 생성
        document.getElementById('roomInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createRoom();
            }
        });

        function createRoom() {
            const roomId = document.getElementById('roomInput').value.trim();
            if (!roomId) {
                showRoomError('방 이름을 입력해주세요.');
                return;
            }

            if (!/^[a-zA-Z0-9]+$/.test(roomId)) {
                showRoomError('방 이름은 영어와 숫자로만 구성되어야 합니다.');
                return;
            }

            const privacy = document.querySelector('input[name="privacy"]:checked').value;
            const password = document.getElementById('roomPassword').value.trim();

            if (privacy === 'private' && !password) {
                showRoomError('비공개 방에는 비밀번호가 필요합니다.');
                return;
            }

            updateStatus('방 생성 중...');

            if (window.wsClient) {
                const message = {
                    type: 'create_room',
                    roomId: roomId,
                    privacy: privacy
                };

                if (privacy === 'private') {
                    message.password = password;
                }

                window.wsClient.send(message);
            }
        }

        function joinRoom() {
            const roomId = document.getElementById('roomInput').value.trim();
            if (!roomId) {
                showRoomError('방 이름을 입력해주세요.');
                return;
            }

            if (!/^[a-zA-Z0-9]+$/.test(roomId)) {
                showRoomError('방 이름은 영어와 숫자로만 구성되어야 합니다.');
                return;
            }

            updateStatus('방 참여 중...');

            // 방 목록에서 해당 방의 정보를 확인하여 private 방인지 체크
            fetch('/rooms')
                .then(response => response.json())
                .then(data => {
                    const room = data.rooms.find(r => r.roomId === roomId);

                    if (room && room.privacy === 'private') {
                        // 비밀번호 입력 프롬프트
                        const password = prompt('비밀번호를 입력하세요:');
                        if (!password) {
                            updateStatus('방 참여가 취소되었습니다.');
                            return;
                        }

                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: roomId,
                                password: password
                            });
                        }
                    } else {
                        // 공개방 또는 존재하지 않는 방
                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: roomId
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('방 목록 조회 실패:', error);
                    // 방 목록 조회 실패 시 일반 참여 시도
                    if (window.wsClient) {
                        window.wsClient.send({
                            type: 'join_room',
                            roomId: roomId
                        });
                    }
                });
        }

        function leaveRoom() {
            currentRoomId = null;
            currentRole = null;
            window.isHost = false;

            // UI 초기화
            document.getElementById('initialSection').style.display = 'block';
            document.getElementById('joinedSection').style.display = 'none';
            document.getElementById('uploadSection').classList.remove('show');
            document.getElementById('viewerSection').classList.add('hidden');
            document.getElementById('roomInput').value = '';
            document.getElementById('roomPassword').value = '';
            document.querySelector('input[name="privacy"][value="public"]').checked = true;
            document.getElementById('passwordInputGroup').classList.remove('show');

            // localStorage에서 호스트 정보 삭제
            localStorage.removeItem('pdfViewerHostInfo');

            updateStatus('방에서 나갔습니다.');

            // 페이지 새로고침으로 완전 초기화
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        function shareRoomLink() {
            if (!currentRoomId) return;

            // 방 정보 확인
            fetch('/rooms')
                .then(response => response.json())
                .then(data => {
                    const room = data.rooms.find(r => r.roomId === currentRoomId);
                    if (!room) {
                        showToast('방 정보를 찾을 수 없습니다.', 'error');
                        return;
                    }

                    const baseUrl = window.location.origin + window.location.pathname;
                    let shareUrl;

                    if (room.privacy === 'private') {
                        // 비공개 방인 경우 비밀번호 입력 요청
                        const password = prompt('공유할 비밀번호를 입력하세요:');
                        if (!password) {
                            showToast('공유가 취소되었습니다.', 'warning');
                            return;
                        }
                        shareUrl = `${baseUrl}?room=${currentRoomId}&pw=${encodeURIComponent(password)}`;
                    } else {
                        // 공개 방인 경우
                        shareUrl = `${baseUrl}?room=${currentRoomId}`;
                    }

                    // 클립보드에 복사 시도
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(shareUrl).then(() => {
                            showToast('방 링크가 클립보드에 복사되었습니다!', 'success');
                        }).catch(() => {
                            fallbackShare(shareUrl);
                        });
                    } else {
                        fallbackShare(shareUrl);
                    }
                })
                .catch(error => {
                    console.error('방 정보 조회 실패:', error);
                    showToast('방 정보를 확인할 수 없습니다.', 'error');
                });
        }

        function fallbackShare(url) {
            // 클립보드 API를 사용할 수 없는 경우 프롬프트로 표시
            const textArea = document.createElement('textarea');
            textArea.value = url;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showToast('방 링크가 클립보드에 복사되었습니다!', 'success');
            } catch (error) {
                // 복사 실패 시 URL을 alert으로 표시
                alert(`방 링크를 복사해주세요:\n${url}`);
            }

            document.body.removeChild(textArea);
        }

        function showRoomError(message) {
            const errorElement = document.getElementById('roomError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 9999);
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // 파일 업로드 함수
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('pdf', file);

            updateStatus('PDF 업로드 중...');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    updateStatus(`PDF 업로드 완료: ${result.pdf.originalName}`);

                    // WebSocket으로 PDF 업로드 알림
                    if (window.wsClient) {
                        window.wsClient.send({
                            type: 'upload_pdf',
                            pdf: result.pdf
                        });
                    }

                    // 업로드 완료 후 업로드 섹션 숨기기
                    document.getElementById('uploadSection').classList.remove('show');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                updateStatus(`업로드 실패: ${error.message}`);
                throw error; // 에러를 다시 던져서 호출자가 처리할 수 있도록
            }
        }

        // 드래그 앤 드롭
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', (event) => {
            // 파일 입력 자체가 클릭된 경우는 무시
            if (event.target === fileInput) return;
            fileInput.click();
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                try {
                    await uploadFile(files[0]);
                } catch (error) {
                    // 에러는 uploadFile 함수 내에서 이미 처리됨
                }
            }
        });

        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (file) {
                try {
                    await uploadFile(file);
                } catch (error) {
                    // 에러는 uploadFile 함수 내에서 이미 처리됨
                }
            }
        });

        // 페이지 컨트롤
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (window.isHost && window.pdfViewer) {
                const currentPage = window.pdfViewer.getCurrentPage();
                if (currentPage > 1) {
                    changePage(currentPage - 1);
                }
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (window.isHost && window.pdfViewer) {
                const currentPage = window.pdfViewer.getCurrentPage();
                const totalPages = window.pdfViewer.getTotalPages();
                if (currentPage < totalPages) {
                    changePage(currentPage + 1);
                }
            }
        });

        // 채팅 기능
        document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        function changePage(pageNum) {
            if (window.isHost && window.pdfViewer) {
                const result = window.pdfViewer.goToPage(pageNum);
                if (result !== null) {
                    // WebSocket으로 페이지 변경 알림 (호스트 자신은 제외하고 뷰어들에게만 전송)
                    if (window.wsClient) {
                        window.wsClient.send({
                            type: 'page_change',
                            page: pageNum
                        });
                    }
                }
            }
        }

        // WebSocket 이벤트 핸들러들
        window.addEventListener('room_joined', (event) => {
            const { roomId, isHost } = event.detail;

            currentRoomId = roomId;
            currentRole = isHost ? '호스트' : '참가자';
            window.isHost = isHost;

            // UI 업데이트
            document.getElementById('initialSection').style.display = 'none';
            document.getElementById('joinedSection').style.display = 'block';
            document.getElementById('currentRoomId').textContent = roomId;
            document.getElementById('currentRole').textContent = currentRole;

            // 호스트인 경우 업로드 섹션 표시
            if (isHost) {
                document.getElementById('uploadSection').classList.add('show');
            }

            // 뷰어 섹션 표시
            document.getElementById('viewerSection').classList.remove('hidden');

            updateStatus(`${currentRole}로 방 ${roomId}에 참여했습니다.`);

            // 성공 toast 알림
            showToast(`${currentRole}로 방 ${roomId}에 참여했습니다.`, 'success');

            // 호스트 정보 localStorage에 저장 (브라우저가 같으면 탭 변경 시에도 유지)
            const hostInfo = {
                roomId: roomId,
                isHost: isHost,
                privacy: event.detail.privacy,
                timestamp: new Date().getTime()
            };
            localStorage.setItem('pdfViewerHostInfo', JSON.stringify(hostInfo));

            // 방 목록 새로고침
            loadRoomList();
        });

        window.addEventListener('room_error', (event) => {
            const { message } = event.detail;
            updateStatus(`오류: ${message}`);
            showRoomError(message);

            // toast 알림 추가
            if (message.includes('비밀번호가 일치하지 않습니다')) {
                showToast('비밀번호가 틀렸습니다.', 'error');
            } else if (message.includes('존재하지 않는 방입니다')) {
                showToast('존재하지 않는 방입니다.', 'error');
            } else {
                showToast(message, 'error');
            }
        });

        window.addEventListener('pdf_loaded', async (event) => {
            try {
                await window.pdfViewer.loadPDF(`/uploads/${event.detail.pdf.filename}`);
                updateStatus('PDF 로드 완료');
            } catch (error) {
                updateStatus(`PDF 로드 실패: ${error.message}`);
            }
        });

        window.addEventListener('page_change', (event) => {
            if (!window.isHost && window.pdfViewer) {
                window.pdfViewer.goToPage(event.detail.page);
            }
        });

        window.addEventListener('chat_message', (event) => {
            displayChatMessage(event.detail);
        });

        // 전체화면 버튼 이벤트
        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);

        // ESC 키로 전체화면 종료 및 방향키로 페이지 이동
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && isFullscreen) {
                exitFullscreen();
            }

            // 방향키로 페이지 이동 (호스트 모드에서만)
            if (window.isHost && window.pdfViewer) {
                if (event.key === 'ArrowLeft') {
                    // 왼쪽 화살표: 이전 페이지
                    event.preventDefault();
                    const currentPage = window.pdfViewer.getCurrentPage();
                    if (currentPage > 1) {
                        changePage(currentPage - 1);
                    }
                } else if (event.key === 'ArrowRight') {
                    // 오른쪽 화살표: 다음 페이지
                    event.preventDefault();
                    const currentPage = window.pdfViewer.getCurrentPage();
                    const totalPages = window.pdfViewer.getTotalPages();
                    if (currentPage < totalPages) {
                        changePage(currentPage + 1);
                    }
                }
            }
        });

        // 브라우저 전체화면 변경 감지
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                exitFullscreen();
            }
        });

        function toggleFullscreen() {
            if (!isFullscreen) {
                enterFullscreen();
            } else {
                exitFullscreen();
            }
        }

        function enterFullscreen() {
            const viewerSection = document.getElementById('viewerSection');
            const canvas = document.getElementById('pdfCanvas');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const pageControls = document.querySelector('.page-controls');

            // 브라우저 전체화면 API 사용
            if (viewerSection.requestFullscreen) {
                viewerSection.requestFullscreen();
            } else if (viewerSection.webkitRequestFullscreen) {
                viewerSection.webkitRequestFullscreen();
            } else if (viewerSection.msRequestFullscreen) {
                viewerSection.msRequestFullscreen();
            }

            // CSS 클래스로 시각적 전체화면 효과 적용
            viewerSection.classList.add('fullscreen');
            canvas.classList.add('fullscreen');

            // 네비게이션 요소들 숨기기
            fullscreenBtn.style.display = 'none';
            if (pageControls) {
                pageControls.style.display = 'none';
            }

            isFullscreen = true;

            // PDF 뷰어에 전체화면 모드 알림
            if (window.pdfViewer) {
                window.pdfViewer.setFullscreenMode(true);
            }

            // 창 크기 변경 시 스케일 재조정
            window.addEventListener('resize', handleResize);
        }

        function exitFullscreen() {
            const viewerSection = document.getElementById('viewerSection');
            const canvas = document.getElementById('pdfCanvas');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const pageControls = document.querySelector('.page-controls');

            // 브라우저 전체화면 종료
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }

            // CSS 클래스 제거
            viewerSection.classList.remove('fullscreen');
            canvas.classList.remove('fullscreen');

            // 버튼 텍스트 복원
            fullscreenBtn.textContent = '전체화면';

            // 네비게이션 요소들 다시 보이기
            fullscreenBtn.style.display = '';
            if (pageControls) {
                pageControls.style.display = '';
            }

            isFullscreen = false;

            // PDF 뷰어에 전체화면 모드 종료 알림
            if (window.pdfViewer) {
                window.pdfViewer.setFullscreenMode(false);
            }

            // 창 크기 변경 이벤트 리스너 제거
            window.removeEventListener('resize', handleResize);
        }

        function handleResize() {
            if (isFullscreen && window.pdfViewer) {
                window.pdfViewer.adjustScaleForFullscreen();
            }
        }

        // 페이지 로드 시 방 목록 자동 로드 및 URL 파라미터 확인
        window.addEventListener('load', () => {
            loadRoomList();

            // 먼저 localStorage에서 호스트 정보 확인 (높은 우선순위)
            const hostInfo = getStoredHostInfo();
            if (hostInfo) {
                // localStorage에 저장된 호스트 정보가 있으면 자동 참여
                setTimeout(() => {
                    autoJoinFromStorage(hostInfo);
                }, 500);
            } else {
                // URL 쿼리스트링에서 방 정보 확인 및 자동 참여
                setTimeout(() => {
                    const urlParams = getUrlParameters();
                    if (urlParams.room) {
                        autoJoinRoom(urlParams.room, urlParams.password);
                    }
                }, 1000); // 방 목록 로드 후 1초 대기
            }
        });

        // URL 파라미터를 통한 자동 방 참여
        function autoJoinRoom(roomId, password) {
            if (!roomId || !/^[a-zA-Z0-9]+$/.test(roomId)) {
                showToast('잘못된 방 이름입니다.', 'error');
                cleanUrl();
                return;
            }

            updateStatus('URL에서 방 정보 확인 중...');

            // 방 목록에서 해당 방 확인
            fetch('/rooms')
                .then(response => response.json())
                .then(data => {
                    const room = data.rooms.find(r => r.roomId === roomId);

                    if (!room) {
                        showToast('존재하지 않는 방입니다.', 'error');
                        cleanUrl();
                        updateStatus('존재하지 않는 방입니다.');
                        return;
                    }

                    // 방 참여 시도
                    updateStatus(`방 ${roomId}에 참여 중...`);

                    if (room.privacy === 'private') {
                        if (!password) {
                            showToast('비공개 방입니다. 비밀번호가 필요합니다.', 'warning');
                            cleanUrl();
                            updateStatus('비밀번호가 필요합니다.');
                            return;
                        }

                        // 비공개 방 참여
                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: roomId,
                                password: password
                            });
                        }
                    } else {
                        // 공개 방 참여
                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: roomId
                            });
                        }
                    }

                    // URL에서 방 정보 제거
                    cleanUrl();
                })
                .catch(error => {
                    console.error('방 목록 조회 실패:', error);
                    showToast('방 정보를 확인할 수 없습니다.', 'error');
                    cleanUrl();
                });
        }

        function loadRoomList() {
            const container = document.getElementById('roomListContainer');
            container.innerHTML = '<div class="no-rooms">방 목록을 불러오는 중...</div>';

            fetch('/rooms')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.rooms.length > 0) {
                        container.innerHTML = '';
                        data.rooms.forEach(room => {
                            const roomElement = createRoomElement(room);
                            container.appendChild(roomElement);
                        });
                    } else {
                        container.innerHTML = '<div class="no-rooms">현재 생성된 방이 없습니다.</div>';
                    }
                })
                .catch(error => {
                    console.error('방 목록 로드 실패:', error);
                    container.innerHTML = '<div class="no-rooms">방 목록을 불러오는데 실패했습니다.</div>';
                });
        }

        function createRoomElement(room) {
            const roomDiv = document.createElement('div');
            roomDiv.className = 'room-list-item';

            const privacyText = room.privacy === 'private' ? '비공개' : '공개';
            const pdfStatus = room.hasPdf ? 'PDF 있음' : 'PDF 없음';
            const createdTime = new Date(room.createdAt).toLocaleString('ko-KR');

            roomDiv.innerHTML = `
                <div class="room-info">
                    <div class="room-name">${room.roomId}</div>
                    <div class="room-details">
                        <span class="room-privacy ${room.privacy}">${privacyText}</span>
                        | 참여자: ${room.clientCount}명 | ${pdfStatus} | 생성: ${createdTime}
                    </div>
                </div>
                <button class="btn-join-room" onclick="joinRoomFromList('${room.roomId}', '${room.privacy}')">
                    참여하기
                </button>
            `;

            return roomDiv;
        }

        function joinRoomFromList(roomId, privacy) {
            if (privacy === 'private') {
                const password = prompt('비밀번호를 입력하세요:');
                if (!password) {
                    updateStatus('방 참여가 취소되었습니다.');
                    return;
                }

                updateStatus('방 참여 중...');
                if (window.wsClient) {
                    window.wsClient.send({
                        type: 'join_room',
                        roomId: roomId,
                        password: password
                    });
                }
            } else {
                updateStatus('방 참여 중...');
                if (window.wsClient) {
                    window.wsClient.send({
                        type: 'join_room',
                        roomId: roomId
                    });
                }
            }
        }

        // 호스트 정보 저장/복원 함수들
        function getStoredHostInfo() {
            try {
                const stored = localStorage.getItem('pdfViewerHostInfo');
                if (!stored) return null;

                const hostInfo = JSON.parse(stored);

                // 타임스탬프 검증 (24시간 이내인지 확인)
                const now = new Date().getTime();
                const hours24 = 24 * 60 * 60 * 1000;
                if (now - hostInfo.timestamp > hours24) {
                    localStorage.removeItem('pdfViewerHostInfo');
                    return null;
                }

                return hostInfo;
            } catch (error) {
                console.error('호스트 정보 로드 실패:', error);
                localStorage.removeItem('pdfViewerHostInfo');
                return null;
            }
        }

        function autoJoinFromStorage(hostInfo) {
            if (!hostInfo.roomId) {
                localStorage.removeItem('pdfViewerHostInfo');
                return;
            }

            updateStatus(`저장된 호스트 정보로 방 ${hostInfo.roomId}에 참여 중...`);

            // 방 목록에서 해당 방 확인
            fetch('/rooms')
                .then(response => response.json())
                .then(data => {
                    const room = data.rooms.find(r => r.roomId === hostInfo.roomId);

                    if (!room) {
                        showToast('저장된 방이 존재하지 않습니다.', 'error');
                        localStorage.removeItem('pdfViewerHostInfo');
                        updateStatus('저장된 방이 존재하지 않습니다.');
                        return;
                    }

                    // 방 참여 시도
                    if (room.privacy === 'private') {
                        if (!hostInfo.privacy || hostInfo.privacy !== 'private') {
                            showToast('저장된 방 정보가 유효하지 않습니다.', 'error');
                            localStorage.removeItem('pdfViewerHostInfo');
                            return;
                        }

                        // 비밀번호 입력 요청 (저장된 정보에 비밀번호가 없으므로)
                        const password = prompt(`방 ${hostInfo.roomId}의 비밀번호를 입력하세요:`);
                        if (!password) {
                            updateStatus('참여가 취소되었습니다.');
                            localStorage.removeItem('pdfViewerHostInfo');
                            return;
                        }

                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: hostInfo.roomId,
                                password: password
                            });
                        }
                    } else {
                        // 공개 방 참여
                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: hostInfo.roomId
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('방 목록 조회 실패:', error);
                    showToast('방 정보를 확인할 수 없습니다.', 'error');
                    localStorage.removeItem('pdfViewerHostInfo');
                });
        }

        // 채팅 기능 함수들
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (!message) {
                return;
            }

            if (!currentRoomId) {
                showToast('방에 참여한 후 채팅을 사용할 수 있습니다.', 'warning');
                return;
            }

            // WebSocket으로 채팅 메시지 전송
            if (window.wsClient) {
                window.wsClient.send({
                    type: 'send_chat',
                    content: message
                });

                // 입력창 초기화
                chatInput.value = '';
            }
        }

        function displayChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');

            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${message.isHost ? 'own' : 'other'}`;

            const senderElement = document.createElement('div');
            senderElement.className = 'sender';
            senderElement.textContent = message.sender;

            const contentElement = document.createElement('div');
            contentElement.className = 'content';
            contentElement.textContent = message.content;

            messageElement.appendChild(senderElement);
            messageElement.appendChild(contentElement);

            chatMessages.appendChild(messageElement);

            // 스크롤을 최하단으로 이동
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>
