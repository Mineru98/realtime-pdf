<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ PDF ë·°ì–´</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #DBE5FA;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background-color: #183994;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-list-section {
            margin: 20px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e1e5e9;
        }

        .room-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .room-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .room-list-item:hover {
            background-color: #e8f0ff;
        }

        .room-info {
            flex: 1;
        }

        .room-name {
            font-weight: bold;
            color: #183994;
            margin-bottom: 5px;
        }

        .room-details {
            font-size: 12px;
            color: #666;
        }

        .room-privacy {
            background-color: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }

        .room-privacy.private {
            background-color: #dc3545;
        }

        .btn-join-room {
            background-color: #208BBF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-join-room:hover {
            background-color: #1a7ab0;
        }

        .no-rooms {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        .room-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .room-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }


        .privacy-radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .password-input-group {
            display: none;
            margin-left: 20px;
        }

        .password-input-group.show {
            display: block;
        }

        .room-input {
            padding: 8px 12px;
            border: 1px solid #c8d4ff;
            border-radius: 4px;
            font-size: 14px;
            width: 150px;
        }

        .room-input.error {
            border-color: #e74c3c;
        }

        .role-selector {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-host {
            background-color: #208BBF;
            color: white;
        }

        .btn-host:hover {
            background-color: #1a7ab0;
        }

        .btn-host.active {
            background-color: #183994;
        }

        .btn-viewer {
            background-color: #208BBF;
            color: white;
        }

        .btn-viewer:hover {
            background-color: #1a7ab0;
        }

        .btn-viewer.active {
            background-color: #183994;
        }

        .upload-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: none;
        }

        .upload-section.show {
            display: block;
        }

        .viewer-section {
            display: flex;
            gap: 20px;
            height: 70vh;
        }

        .pdf-container {
            flex: 1;
            position: relative;
        }

        .pdf-viewer {
            height: 100%;
            border: none;
            width: 100%;
            max-width: none;
            max-height: none;
            transition: height 0.3s ease;
        }

        /* FAB ì±„íŒ… ìŠ¤íƒ€ì¼ */
        .chat-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chat-fab-button {
            position: relative;
            width: 56px;
            height: 56px;
            background-color: #208BBF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .chat-fab-button:hover {
            background-color: #1a7ab0;
            transform: scale(1.1);
        }

        .chat-icon {
            font-size: 24px;
            color: white;
        }

        .chat-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            min-width: 14px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .chat-panel {
            position: absolute;
            bottom: 76px;
            right: 0;
            width: 320px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-header {
            padding: 15px;
            background-color: #183994;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .chat-header {
            padding: 15px;
            background-color: #183994;
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .close-chat-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close-chat-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f9fa;
            max-height: calc(70vh - 120px);
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.own {
            background-color: #208BBF;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .chat-message.other {
            background-color: white;
            color: #333;
            border: 1px solid #e1e5e9;
        }

        .chat-message .sender {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .chat-message .content {
            font-size: 14px;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            gap: 10px;
            background: white;
            border-top: 1px solid #e1e5e9;
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #c8d4ff;
            border-radius: 4px;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #208BBF;
        }

        .send-chat-btn {
            padding: 8px 16px;
            background-color: #208BBF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .send-chat-btn:hover {
            background-color: #1a7ab0;
        }

        .pdf-viewer.fullscreen {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            background-color: #000;
        }

        .viewer-section.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            background-color: #000;
            overflow: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
        }

        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-size: 16px;
        }

        .fullscreen-btn:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        .status {
            padding: 10px 20px;
            background-color: #f0f4ff;
            border-top: 1px solid #c8d4ff;
            font-size: 14px;
            color: #183994;
        }

        .page-controls {
            padding: 10px 20px;
            background-color: #f0f4ff;
            border-top: 1px solid #c8d4ff;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1001;
        }

        .viewer-section.fullscreen .page-controls,
        .viewer-section.fullscreen .fullscreen-btn {
            display: none;
        }

        .viewer-section.fullscreen .page-info {
            color: white;
        }

        .page-info {
            font-weight: bold;
            color: #183994;
        }

        .hidden {
            display: none !important;
        }

        .drop-zone {
            border: 2px dashed #c8d4ff;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            background-color: #f0f4ff;
            transition: border-color 0.3s;
        }

        .drop-zone.dragover {
            border-color: #208BBF;
            background-color: #e8f0ff;
        }

        .file-input {
            margin: 10px 0;
        }

        #pdfCanvas {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            /* í™”ì§ˆ ê°œì„ ì„ ìœ„í•œ CSS */
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            -ms-interpolation-mode: nearest-neighbor;
            image-rendering: pixelated; /* ê³ í™”ì§ˆ ìœ ì§€ */
            /* Canvas í™•ëŒ€ ì‹œ ì„ ëª…ë„ ìœ ì§€ */
            transform: scale(1); /* ê¸°ë³¸ ìŠ¤ì¼€ì¼ ê³ ì • */
        }

        /* ì „ì²´ ì»¨í…Œì´ë„ˆ ìŠ¤ì¼€ì¼ë§ ë°©ì§€ */
        .pdf-container {
            transform-origin: top left;
            overflow: auto;
        }

        /* ì „ì²´í™”ë©´ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ FAB ìˆ¨ê¹€ */
        .viewer-section.fullscreen .chat-fab {
            display: none;
        }

        /* ì „ì²´í™”ë©´ ì‹œ ë©”ì‹œì§€ê°€ ìˆì„ ë•Œë§Œ FAB í‘œì‹œ */
        .viewer-section.fullscreen .chat-fab.has-messages {
            display: block;
        }

        .viewer-section.fullscreen #pdfCanvas {
            position: absolute !important;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Toast ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }

        .toast.warning {
            background-color: #ffc107;
            color: #212529;
        }

        .toast.info {
            background-color: #17a2b8;
        }

        .toast-close {
            float: right;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
        }

        .toast-close:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ì‹¤ì‹œê°„ PDF ë·°ì–´</h1>
            <div id="initialSection" class="room-section">
                <div class="room-input-group">
                    <label for="roomInput">ë°© ì´ë¦„:</label>
                    <input type="text" id="roomInput" class="room-input" placeholder="ì˜ì–´/ìˆ«ìë§Œ ì…ë ¥" maxlength="20">
                    <div class="privacy-radio-group">
                        <label>
                            <input type="radio" name="privacy" value="public" checked> ê³µê°œë°©
                        </label>
                        <label>
                            <input type="radio" name="privacy" value="private"> ë¹„ê³µê°œë°©
                        </label>
                    </div>
                    <button id="createRoomBtn" class="btn-host">ë°© ìƒì„±</button>
                    <div id="passwordInputGroup" class="password-input-group">
                        <label for="roomPassword">ë¹„ë°€ë²ˆí˜¸:</label>
                        <input type="password" id="roomPassword" class="room-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" maxlength="50">
                    </div>
                </div>
                <div id="roomError" class="error-message" style="color: #e74c3c; font-size: 12px; display: none;"></div>
            </div>
            <div id="joinedSection" class="room-section" style="display: none;">
                <div>ë°©: <span id="currentRoomId"></span> | ì—­í• : <span id="currentRole"></span></div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                    <button id="shareRoomBtn" class="btn-viewer" style="font-size: 14px; padding: 6px 12px;">ë°© ë§í¬ ê³µìœ </button>
                    <button id="leaveRoomBtn" class="btn-viewer">ë°© ë‚˜ê°€ê¸°</button>
                </div>
            </div>
        </div>

        <!-- ë°© ëª©ë¡ ì„¹ì…˜ -->
        <div class="room-list-section">
            <div class="room-list-header">
                <h2>ë°© ëª©ë¡</h2>
                <button id="refreshRoomListBtn" class="btn-viewer" style="font-size: 14px; padding: 6px 12px;">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="roomListContainer">
                <div class="no-rooms">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <div id="uploadSection" class="upload-section">
            <div class="drop-zone" id="dropZone">
                <p>PDF íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”</p>
                <input type="file" id="fileInput" accept=".pdf" class="file-input">
            </div>
        </div>

        <div id="viewerSection" class="hidden">
            <div class="pdf-container">
                <canvas id="pdfCanvas" class="pdf-viewer"></canvas>
                <button id="fullscreenBtn" class="fullscreen-btn">ì „ì²´í™”ë©´</button>
                <div class="page-controls">
                    <button id="prevBtn">ì´ì „</button>
                    <span id="pageInfo" class="page-info">í˜ì´ì§€ ë¡œë”© ì¤‘...</span>
                    <button id="nextBtn">ë‹¤ìŒ</button>
                </div>
            </div>
            <!-- FAB ì±„íŒ… ë²„íŠ¼ -->
            <div id="chatFab" class="chat-fab">
                <div class="chat-fab-button">
                    <span class="chat-icon">ğŸ’¬</span>
                    <span id="chatBadge" class="chat-badge" style="display: none;">0</span>
                </div>
                <div id="chatPanel" class="chat-panel" style="display: none;">
                    <div class="chat-header">
                        <h3>ì±„íŒ…</h3>
                        <button id="closeChatBtn" class="close-chat-btn">&times;</button>
                    </div>
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="200">
                        <button id="sendChatBtn" class="send-chat-btn">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="status" class="status">
            ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
        </div>

    </div>

    <!-- Toast ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- WebSocket í´ë¼ì´ì–¸íŠ¸ -->
    <script src="js/websocket.js"></script>

    <!-- PDF ë·°ì–´ -->
    <script src="js/viewer.js"></script>

    <script>
        // PDF.js ì›Œì»¤ ì„¤ì •
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let currentRoomId = null;
        let currentRole = null;
        let isFullscreen = false;
        let unreadMessageCount = 0;

        // Toast ì•Œë¦¼ í•¨ìˆ˜ë“¤
        function showToast(message, type = 'info', duration = 4000) {
            const toastContainer = document.getElementById('toastContainer');

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-close" onclick="this.parentElement.remove()">&times;</span>
                ${message}
            `;

            toastContainer.appendChild(toast);

            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
            setTimeout(() => toast.classList.add('show'), 10);

            // ìë™ ì œê±°
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // URL ì¿¼ë¦¬ìŠ¤íŠ¸ë§ íŒŒì‹± í•¨ìˆ˜
        function getUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const room = urlParams.get('room');
            const pw = urlParams.get('pw');

            return {
                room: room,
                password: pw
            };
        }

        // URLì—ì„œ ë°© ì •ë³´ ì œê±° (ê¹”ë”í•œ URL ìœ ì§€)
        function cleanUrl() {
            const url = new URL(window.location);
            url.searchParams.delete('room');
            url.searchParams.delete('pw');
            window.history.replaceState({}, document.title, url.pathname + url.hash);
        }

        // ë°© ìƒì„±
        document.getElementById('createRoomBtn').addEventListener('click', () => {
            createRoom();
        });

        document.getElementById('leaveRoomBtn').addEventListener('click', () => {
            leaveRoom();
        });

        document.getElementById('shareRoomBtn').addEventListener('click', () => {
            shareRoomLink();
        });

        // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        document.getElementById('refreshRoomListBtn').addEventListener('click', () => {
            loadRoomList();
        });

        // ë°© ì´ë¦„ ì…ë ¥ ê²€ì¦
        document.getElementById('roomInput').addEventListener('input', (e) => {
            const value = e.target.value;
            const isValid = /^[a-zA-Z0-9]*$/.test(value);

            e.target.classList.toggle('error', !isValid);
            document.getElementById('roomError').style.display = isValid ? 'none' : 'block';
            document.getElementById('roomError').textContent = isValid ? '' : 'ì˜ì–´ì™€ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
        });

        // privacy ì„¤ì • ë³€ê²½ ì´ë²¤íŠ¸
        document.querySelectorAll('input[name="privacy"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const passwordGroup = document.getElementById('passwordInputGroup');
                if (e.target.value === 'private') {
                    passwordGroup.classList.add('show');
                } else {
                    passwordGroup.classList.remove('show');
                    document.getElementById('roomPassword').value = '';
                }
            });
        });

        // Enter í‚¤ë¡œ ë°© ìƒì„±
        document.getElementById('roomInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createRoom();
            }
        });

        function createRoom() {
            const roomId = document.getElementById('roomInput').value.trim();
            if (!roomId) {
                showRoomError('ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!/^[a-zA-Z0-9]+$/.test(roomId)) {
                showRoomError('ë°© ì´ë¦„ì€ ì˜ì–´ì™€ ìˆ«ìë¡œë§Œ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const privacy = document.querySelector('input[name="privacy"]:checked').value;
            const password = document.getElementById('roomPassword').value.trim();

            if (privacy === 'private' && !password) {
                showRoomError('ë¹„ê³µê°œ ë°©ì—ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            updateStatus('ë°© ìƒì„± ì¤‘...');

            if (window.wsClient) {
                const message = {
                    type: 'create_room',
                    roomId: roomId,
                    privacy: privacy
                };

                if (privacy === 'private') {
                    message.password = password;
                }

                window.wsClient.send(message);
            }
        }

        function joinRoom() {
            const roomId = document.getElementById('roomInput').value.trim();
            if (!roomId) {
                showRoomError('ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!/^[a-zA-Z0-9]+$/.test(roomId)) {
                showRoomError('ë°© ì´ë¦„ì€ ì˜ì–´ì™€ ìˆ«ìë¡œë§Œ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            updateStatus('ë°© ì°¸ì—¬ ì¤‘...');

            // ë°© ëª©ë¡ì—ì„œ í•´ë‹¹ ë°©ì˜ ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ private ë°©ì¸ì§€ ì²´í¬
            fetch('/rooms')
                .then(response => response.json())
                .then(data => {
                    const room = data.rooms.find(r => r.roomId === roomId);

                    if (room && room.privacy === 'private') {
                        // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í”„ë¡¬í”„íŠ¸
                        const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                        if (!password) {
                            updateStatus('ë°© ì°¸ì—¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            return;
                        }

                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: roomId,
                                password: password
                            });
                        }
                    } else {
                        // ê³µê°œë°© ë˜ëŠ” ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©
                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: roomId
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    // ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì¼ë°˜ ì°¸ì—¬ ì‹œë„
                    if (window.wsClient) {
                        window.wsClient.send({
                            type: 'join_room',
                            roomId: roomId
                        });
                    }
                });
        }

        function leaveRoom() {
            currentRoomId = null;
            currentRole = null;
            window.isHost = false;

            // UI ì´ˆê¸°í™”
            document.getElementById('initialSection').style.display = 'block';
            document.getElementById('joinedSection').style.display = 'none';
            document.getElementById('uploadSection').classList.remove('show');
            document.getElementById('viewerSection').classList.add('hidden');
            document.getElementById('roomInput').value = '';
            document.getElementById('roomPassword').value = '';
            document.querySelector('input[name="privacy"][value="public"]').checked = true;
            document.getElementById('passwordInputGroup').classList.remove('show');

            // localStorageì—ì„œ í˜¸ìŠ¤íŠ¸ ì •ë³´ ì‚­ì œ
            localStorage.removeItem('pdfViewerHostInfo');

            updateStatus('ë°©ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.');

            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì™„ì „ ì´ˆê¸°í™”
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        function shareRoomLink() {
            if (!currentRoomId) return;

            // ë°© ì •ë³´ í™•ì¸
            fetch('/rooms')
                .then(response => response.json())
                .then(data => {
                    const room = data.rooms.find(r => r.roomId === currentRoomId);
                    if (!room) {
                        showToast('ë°© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }

                    const baseUrl = window.location.origin + window.location.pathname;
                    let shareUrl;

                    if (room.privacy === 'private') {
                        // ë¹„ê³µê°œ ë°©ì¸ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ìš”ì²­
                        const password = prompt('ê³µìœ í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                        if (!password) {
                            showToast('ê³µìœ ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
                            return;
                        }
                        shareUrl = `${baseUrl}?room=${currentRoomId}&pw=${encodeURIComponent(password)}`;
                    } else {
                        // ê³µê°œ ë°©ì¸ ê²½ìš°
                        shareUrl = `${baseUrl}?room=${currentRoomId}`;
                    }

                    // í´ë¦½ë³´ë“œì— ë³µì‚¬ ì‹œë„
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(shareUrl).then(() => {
                            showToast('ë°© ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                        }).catch(() => {
                            fallbackShare(shareUrl);
                        });
                    } else {
                        fallbackShare(shareUrl);
                    }
                })
                .catch(error => {
                    console.error('ë°© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    showToast('ë°© ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                });
        }

        function fallbackShare(url) {
            // í´ë¦½ë³´ë“œ APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ê²½ìš° í”„ë¡¬í”„íŠ¸ë¡œ í‘œì‹œ
            const textArea = document.createElement('textarea');
            textArea.value = url;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showToast('ë°© ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ URLì„ alertìœ¼ë¡œ í‘œì‹œ
                alert(`ë°© ë§í¬ë¥¼ ë³µì‚¬í•´ì£¼ì„¸ìš”:\n${url}`);
            }

            document.body.removeChild(textArea);
        }

        function showRoomError(message) {
            const errorElement = document.getElementById('roomError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 9999);
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('pdf', file);

            updateStatus('PDF ì—…ë¡œë“œ ì¤‘...');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    updateStatus(`PDF ì—…ë¡œë“œ ì™„ë£Œ: ${result.pdf.originalName}`);

                    // WebSocketìœ¼ë¡œ PDF ì—…ë¡œë“œ ì•Œë¦¼
                    if (window.wsClient) {
                        window.wsClient.send({
                            type: 'upload_pdf',
                            pdf: result.pdf
                        });
                    }

                    // ì—…ë¡œë“œ ì™„ë£Œ í›„ ì—…ë¡œë“œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                    document.getElementById('uploadSection').classList.remove('show');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                updateStatus(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                throw error; // ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ í˜¸ì¶œìê°€ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡
            }
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', (event) => {
            // íŒŒì¼ ì…ë ¥ ìì²´ê°€ í´ë¦­ëœ ê²½ìš°ëŠ” ë¬´ì‹œ
            if (event.target === fileInput) return;
            fileInput.click();
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                try {
                    await uploadFile(files[0]);
                } catch (error) {
                    // ì—ëŸ¬ëŠ” uploadFile í•¨ìˆ˜ ë‚´ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨
                }
            }
        });

        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (file) {
                try {
                    await uploadFile(file);
                } catch (error) {
                    // ì—ëŸ¬ëŠ” uploadFile í•¨ìˆ˜ ë‚´ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨
                }
            }
        });

        // í˜ì´ì§€ ì»¨íŠ¸ë¡¤
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (window.isHost && window.pdfViewer) {
                const currentPage = window.pdfViewer.getCurrentPage();
                if (currentPage > 1) {
                    changePage(currentPage - 1);
                }
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (window.isHost && window.pdfViewer) {
                const currentPage = window.pdfViewer.getCurrentPage();
                const totalPages = window.pdfViewer.getTotalPages();
                if (currentPage < totalPages) {
                    changePage(currentPage + 1);
                }
            }
        });

        // ì±„íŒ… ê¸°ëŠ¥
        document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // FAB ì±„íŒ… í† ê¸€ ê¸°ëŠ¥
        document.getElementById('chatFab').addEventListener('click', (e) => {
            if (e.target.closest('.chat-panel') || e.target.id === 'closeChatBtn') return;

            const chatPanel = document.getElementById('chatPanel');
            const isVisible = chatPanel.style.display !== 'none';

            if (isVisible) {
                hideChatPanel();
            } else {
                showChatPanel();
            }
        });

        // ì±„íŒ… íŒ¨ë„ ë‹«ê¸° ë²„íŠ¼
        document.getElementById('closeChatBtn').addEventListener('click', hideChatPanel);

        // ì±„íŒ… íŒ¨ë„ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            const chatFab = document.getElementById('chatFab');
            const chatPanel = document.getElementById('chatPanel');

            if (!chatFab.contains(e.target) && chatPanel.style.display !== 'none') {
                hideChatPanel();
            }
        });

        function changePage(pageNum) {
            if (window.isHost && window.pdfViewer) {
                const result = window.pdfViewer.goToPage(pageNum);
                if (result !== null) {
                    // WebSocketìœ¼ë¡œ í˜ì´ì§€ ë³€ê²½ ì•Œë¦¼ (í˜¸ìŠ¤íŠ¸ ìì‹ ì€ ì œì™¸í•˜ê³  ë·°ì–´ë“¤ì—ê²Œë§Œ ì „ì†¡)
                    if (window.wsClient) {
                        window.wsClient.send({
                            type: 'page_change',
                            page: pageNum
                        });
                    }
                }
            }
        }

        // WebSocket ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
        window.addEventListener('room_joined', (event) => {
            const { roomId, isHost } = event.detail;

            currentRoomId = roomId;
            currentRole = isHost ? 'í˜¸ìŠ¤íŠ¸' : 'ì°¸ê°€ì';
            window.isHost = isHost;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('initialSection').style.display = 'none';
            document.getElementById('joinedSection').style.display = 'block';
            document.getElementById('currentRoomId').textContent = roomId;
            document.getElementById('currentRole').textContent = currentRole;

            // í˜¸ìŠ¤íŠ¸ì¸ ê²½ìš° ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
            if (isHost) {
                document.getElementById('uploadSection').classList.add('show');
            }

            // ë·°ì–´ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('viewerSection').classList.remove('hidden');

            updateStatus(`${currentRole}ë¡œ ë°© ${roomId}ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.`);

            // ì„±ê³µ toast ì•Œë¦¼
            showToast(`${currentRole}ë¡œ ë°© ${roomId}ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.`, 'success');

            // í˜¸ìŠ¤íŠ¸ ì •ë³´ localStorageì— ì €ì¥ (ë¸Œë¼ìš°ì €ê°€ ê°™ìœ¼ë©´ íƒ­ ë³€ê²½ ì‹œì—ë„ ìœ ì§€)
            const hostInfo = {
                roomId: roomId,
                isHost: isHost,
                privacy: event.detail.privacy,
                timestamp: new Date().getTime()
            };
            localStorage.setItem('pdfViewerHostInfo', JSON.stringify(hostInfo));

            // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadRoomList();
        });

        window.addEventListener('room_error', (event) => {
            const { message } = event.detail;
            updateStatus(`ì˜¤ë¥˜: ${message}`);
            showRoomError(message);

            // toast ì•Œë¦¼ ì¶”ê°€
            if (message.includes('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤')) {
                showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'error');
            } else if (message.includes('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤')) {
                showToast('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.', 'error');
            } else {
                showToast(message, 'error');
            }
        });

        window.addEventListener('pdf_loaded', async (event) => {
            try {
                await window.pdfViewer.loadPDF(`/uploads/${event.detail.pdf.filename}`);
                updateStatus('PDF ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                updateStatus(`PDF ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }
        });

        window.addEventListener('page_change', (event) => {
            if (!window.isHost && window.pdfViewer) {
                window.pdfViewer.goToPage(event.detail.page);
            }
        });

        window.addEventListener('chat_message', (event) => {
            displayChatMessage(event.detail);
        });

        // ì „ì²´í™”ë©´ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);

        // ESC í‚¤ë¡œ ì „ì²´í™”ë©´ ì¢…ë£Œ ë° ë°©í–¥í‚¤ë¡œ í˜ì´ì§€ ì´ë™
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && isFullscreen) {
                exitFullscreen();
            }

            // ë°©í–¥í‚¤ë¡œ í˜ì´ì§€ ì´ë™ (í˜¸ìŠ¤íŠ¸ ëª¨ë“œì—ì„œë§Œ)
            if (window.isHost && window.pdfViewer) {
                if (event.key === 'ArrowLeft') {
                    // ì™¼ìª½ í™”ì‚´í‘œ: ì´ì „ í˜ì´ì§€
                    event.preventDefault();
                    const currentPage = window.pdfViewer.getCurrentPage();
                    if (currentPage > 1) {
                        changePage(currentPage - 1);
                    }
                } else if (event.key === 'ArrowRight') {
                    // ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ: ë‹¤ìŒ í˜ì´ì§€
                    event.preventDefault();
                    const currentPage = window.pdfViewer.getCurrentPage();
                    const totalPages = window.pdfViewer.getTotalPages();
                    if (currentPage < totalPages) {
                        changePage(currentPage + 1);
                    }
                }
            }
        });

        // ë¸Œë¼ìš°ì € ì „ì²´í™”ë©´ ë³€ê²½ ê°ì§€
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                exitFullscreen();
            }
        });

        function toggleFullscreen() {
            if (!isFullscreen) {
                enterFullscreen();
            } else {
                exitFullscreen();
            }
        }

        function enterFullscreen() {
            const viewerSection = document.getElementById('viewerSection');
            const canvas = document.getElementById('pdfCanvas');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const pageControls = document.querySelector('.page-controls');

            // ë¸Œë¼ìš°ì € ì „ì²´í™”ë©´ API ì‚¬ìš©
            if (viewerSection.requestFullscreen) {
                viewerSection.requestFullscreen();
            } else if (viewerSection.webkitRequestFullscreen) {
                viewerSection.webkitRequestFullscreen();
            } else if (viewerSection.msRequestFullscreen) {
                viewerSection.msRequestFullscreen();
            }

            // CSS í´ë˜ìŠ¤ë¡œ ì‹œê°ì  ì „ì²´í™”ë©´ íš¨ê³¼ ì ìš©
            viewerSection.classList.add('fullscreen');
            canvas.classList.add('fullscreen');

            // ë„¤ë¹„ê²Œì´ì…˜ ìš”ì†Œë“¤ ìˆ¨ê¸°ê¸°
            fullscreenBtn.style.display = 'none';
            if (pageControls) {
                pageControls.style.display = 'none';
            }

            isFullscreen = true;

            // PDF ë·°ì–´ì— ì „ì²´í™”ë©´ ëª¨ë“œ ì•Œë¦¼
            if (window.pdfViewer) {
                window.pdfViewer.setFullscreenMode(true);
            }

            // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ìŠ¤ì¼€ì¼ ì¬ì¡°ì •
            window.addEventListener('resize', handleResize);
        }

        function exitFullscreen() {
            const viewerSection = document.getElementById('viewerSection');
            const canvas = document.getElementById('pdfCanvas');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const pageControls = document.querySelector('.page-controls');

            // ë¸Œë¼ìš°ì € ì „ì²´í™”ë©´ ì¢…ë£Œ
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }

            // CSS í´ë˜ìŠ¤ ì œê±°
            viewerSection.classList.remove('fullscreen');
            canvas.classList.remove('fullscreen');

            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µì›
            fullscreenBtn.textContent = 'ì „ì²´í™”ë©´';

            // ë„¤ë¹„ê²Œì´ì…˜ ìš”ì†Œë“¤ ë‹¤ì‹œ ë³´ì´ê¸°
            fullscreenBtn.style.display = '';
            if (pageControls) {
                pageControls.style.display = '';
            }

            isFullscreen = false;

            // PDF ë·°ì–´ì— ì „ì²´í™”ë©´ ëª¨ë“œ ì¢…ë£Œ ì•Œë¦¼
            if (window.pdfViewer) {
                window.pdfViewer.setFullscreenMode(false);
            }

            // ì°½ í¬ê¸° ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            window.removeEventListener('resize', handleResize);
        }

        function handleResize() {
            if (isFullscreen && window.pdfViewer) {
                window.pdfViewer.adjustScaleForFullscreen();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°© ëª©ë¡ ìë™ ë¡œë“œ ë° URL íŒŒë¼ë¯¸í„° í™•ì¸
        window.addEventListener('load', () => {
            loadRoomList();

            // ë¨¼ì € localStorageì—ì„œ í˜¸ìŠ¤íŠ¸ ì •ë³´ í™•ì¸ (ë†’ì€ ìš°ì„ ìˆœìœ„)
            const hostInfo = getStoredHostInfo();
            if (hostInfo) {
                // localStorageì— ì €ì¥ëœ í˜¸ìŠ¤íŠ¸ ì •ë³´ê°€ ìˆìœ¼ë©´ ìë™ ì°¸ì—¬
                setTimeout(() => {
                    autoJoinFromStorage(hostInfo);
                }, 500);
            } else {
                // URL ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ ë°© ì •ë³´ í™•ì¸ ë° ìë™ ì°¸ì—¬
                setTimeout(() => {
                    const urlParams = getUrlParameters();
                    if (urlParams.room) {
                        autoJoinRoom(urlParams.room, urlParams.password);
                    }
                }, 1000); // ë°© ëª©ë¡ ë¡œë“œ í›„ 1ì´ˆ ëŒ€ê¸°
            }
        });

        // URL íŒŒë¼ë¯¸í„°ë¥¼ í†µí•œ ìë™ ë°© ì°¸ì—¬
        function autoJoinRoom(roomId, password) {
            if (!roomId || !/^[a-zA-Z0-9]+$/.test(roomId)) {
                showToast('ì˜ëª»ëœ ë°© ì´ë¦„ì…ë‹ˆë‹¤.', 'error');
                cleanUrl();
                return;
            }

            updateStatus('URLì—ì„œ ë°© ì •ë³´ í™•ì¸ ì¤‘...');

            // ë°© ëª©ë¡ì—ì„œ í•´ë‹¹ ë°© í™•ì¸
            fetch('/rooms')
                .then(response => response.json())
                .then(data => {
                    const room = data.rooms.find(r => r.roomId === roomId);

                    if (!room) {
                        showToast('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.', 'error');
                        cleanUrl();
                        updateStatus('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.');
                        return;
                    }

                    // ë°© ì°¸ì—¬ ì‹œë„
                    updateStatus(`ë°© ${roomId}ì— ì°¸ì—¬ ì¤‘...`);

                    if (room.privacy === 'private') {
                        if (!password) {
                            showToast('ë¹„ê³µê°œ ë°©ì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                            cleanUrl();
                            updateStatus('ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                            return;
                        }

                        // ë¹„ê³µê°œ ë°© ì°¸ì—¬
                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: roomId,
                                password: password
                            });
                        }
                    } else {
                        // ê³µê°œ ë°© ì°¸ì—¬
                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: roomId
                            });
                        }
                    }

                    // URLì—ì„œ ë°© ì •ë³´ ì œê±°
                    cleanUrl();
                })
                .catch(error => {
                    console.error('ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    showToast('ë°© ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    cleanUrl();
                });
        }

        function loadRoomList() {
            const container = document.getElementById('roomListContainer');
            container.innerHTML = '<div class="no-rooms">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            fetch('/rooms')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.rooms.length > 0) {
                        container.innerHTML = '';
                        data.rooms.forEach(room => {
                            const roomElement = createRoomElement(room);
                            container.appendChild(roomElement);
                        });
                    } else {
                        container.innerHTML = '<div class="no-rooms">í˜„ì¬ ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    }
                })
                .catch(error => {
                    console.error('ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    container.innerHTML = '<div class="no-rooms">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
                });
        }

        function createRoomElement(room) {
            const roomDiv = document.createElement('div');
            roomDiv.className = 'room-list-item';

            const privacyText = room.privacy === 'private' ? 'ë¹„ê³µê°œ' : 'ê³µê°œ';
            const pdfStatus = room.hasPdf ? 'PDF ìˆìŒ' : 'PDF ì—†ìŒ';
            const createdTime = new Date(room.createdAt).toLocaleString('ko-KR');

            roomDiv.innerHTML = `
                <div class="room-info">
                    <div class="room-name">${room.roomId}</div>
                    <div class="room-details">
                        <span class="room-privacy ${room.privacy}">${privacyText}</span>
                        | ì°¸ì—¬ì: ${room.clientCount}ëª… | ${pdfStatus} | ìƒì„±: ${createdTime}
                    </div>
                </div>
                <button class="btn-join-room" onclick="joinRoomFromList('${room.roomId}', '${room.privacy}')">
                    ì°¸ì—¬í•˜ê¸°
                </button>
            `;

            return roomDiv;
        }

        function joinRoomFromList(roomId, privacy) {
            if (privacy === 'private') {
                const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                if (!password) {
                    updateStatus('ë°© ì°¸ì—¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                updateStatus('ë°© ì°¸ì—¬ ì¤‘...');
                if (window.wsClient) {
                    window.wsClient.send({
                        type: 'join_room',
                        roomId: roomId,
                        password: password
                    });
                }
            } else {
                updateStatus('ë°© ì°¸ì—¬ ì¤‘...');
                if (window.wsClient) {
                    window.wsClient.send({
                        type: 'join_room',
                        roomId: roomId
                    });
                }
            }
        }

        // í˜¸ìŠ¤íŠ¸ ì •ë³´ ì €ì¥/ë³µì› í•¨ìˆ˜ë“¤
        function getStoredHostInfo() {
            try {
                const stored = localStorage.getItem('pdfViewerHostInfo');
                if (!stored) return null;

                const hostInfo = JSON.parse(stored);

                // íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ (24ì‹œê°„ ì´ë‚´ì¸ì§€ í™•ì¸)
                const now = new Date().getTime();
                const hours24 = 24 * 60 * 60 * 1000;
                if (now - hostInfo.timestamp > hours24) {
                    localStorage.removeItem('pdfViewerHostInfo');
                    return null;
                }

                return hostInfo;
            } catch (error) {
                console.error('í˜¸ìŠ¤íŠ¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                localStorage.removeItem('pdfViewerHostInfo');
                return null;
            }
        }

        function autoJoinFromStorage(hostInfo) {
            if (!hostInfo.roomId) {
                localStorage.removeItem('pdfViewerHostInfo');
                return;
            }

            updateStatus(`ì €ì¥ëœ í˜¸ìŠ¤íŠ¸ ì •ë³´ë¡œ ë°© ${hostInfo.roomId}ì— ì°¸ì—¬ ì¤‘...`);

            // ë°© ëª©ë¡ì—ì„œ í•´ë‹¹ ë°© í™•ì¸
            fetch('/rooms')
                .then(response => response.json())
                .then(data => {
                    const room = data.rooms.find(r => r.roomId === hostInfo.roomId);

                    if (!room) {
                        showToast('ì €ì¥ëœ ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                        localStorage.removeItem('pdfViewerHostInfo');
                        updateStatus('ì €ì¥ëœ ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        return;
                    }

                    // ë°© ì°¸ì—¬ ì‹œë„
                    if (room.privacy === 'private') {
                        if (!hostInfo.privacy || hostInfo.privacy !== 'private') {
                            showToast('ì €ì¥ëœ ë°© ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                            localStorage.removeItem('pdfViewerHostInfo');
                            return;
                        }

                        // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ìš”ì²­ (ì €ì¥ëœ ì •ë³´ì— ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ìœ¼ë¯€ë¡œ)
                        const password = prompt(`ë°© ${hostInfo.roomId}ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
                        if (!password) {
                            updateStatus('ì°¸ì—¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            localStorage.removeItem('pdfViewerHostInfo');
                            return;
                        }

                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: hostInfo.roomId,
                                password: password
                            });
                        }
                    } else {
                        // ê³µê°œ ë°© ì°¸ì—¬
                        if (window.wsClient) {
                            window.wsClient.send({
                                type: 'join_room',
                                roomId: hostInfo.roomId
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    showToast('ë°© ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    localStorage.removeItem('pdfViewerHostInfo');
                });
        }

        // ì±„íŒ… ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (!message) {
                return;
            }

            if (!currentRoomId) {
                showToast('ë°©ì— ì°¸ì—¬í•œ í›„ ì±„íŒ…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            // WebSocketìœ¼ë¡œ ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
            if (window.wsClient) {
                window.wsClient.send({
                    type: 'send_chat',
                    content: message
                });

                // ì…ë ¥ì°½ ì´ˆê¸°í™”
                chatInput.value = '';
            }
        }

        // FAB ì±„íŒ… íŒ¨ë„ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
        function showChatPanel() {
            const chatPanel = document.getElementById('chatPanel');
            const chatFab = document.getElementById('chatFab');
            chatPanel.style.display = 'flex';

            // íŒ¨ë„ì´ ì—´ë¦´ ë•Œ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 100);

            // ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ì´ˆê¸°í™” ë° FAB ìƒíƒœ ì—…ë°ì´íŠ¸
            resetChatBadge();
            chatFab.classList.remove('has-messages');
        }

        function hideChatPanel() {
            const chatPanel = document.getElementById('chatPanel');
            chatPanel.style.display = 'none';
        }

        // ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function updateChatBadge() {
            const chatBadge = document.getElementById('chatBadge');
            const chatPanel = document.getElementById('chatPanel');
            const chatFab = document.getElementById('chatFab');

            if (unreadMessageCount > 0 && (chatPanel.style.display === 'none' || isFullscreen)) {
                chatBadge.textContent = unreadMessageCount > 99 ? '99+' : unreadMessageCount;
                chatBadge.style.display = 'flex';

                // ì „ì²´í™”ë©´ì¼ ë•Œ FAB í‘œì‹œ
                if (isFullscreen) {
                    chatFab.classList.add('has-messages');
                }
            } else {
                chatBadge.style.display = 'none';

                // ì „ì²´í™”ë©´ì¼ ë•Œ FAB ìˆ¨ê¹€
                if (isFullscreen) {
                    chatFab.classList.remove('has-messages');
                }
            }
        }

        function incrementChatBadge() {
            unreadMessageCount++;
            updateChatBadge();
        }

        function resetChatBadge() {
            unreadMessageCount = 0;
            updateChatBadge();
        }

        function displayChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const chatPanel = document.getElementById('chatPanel');
            const chatFab = document.getElementById('chatFab');

            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${message.isHost ? 'own' : 'other'}`;

            const senderElement = document.createElement('div');
            senderElement.className = 'sender';
            senderElement.textContent = message.sender;

            const contentElement = document.createElement('div');
            contentElement.className = 'content';
            contentElement.textContent = message.content;

            messageElement.appendChild(senderElement);
            messageElement.appendChild(contentElement);

            chatMessages.appendChild(messageElement);

            // ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // ì±„íŒ… íŒ¨ë„ì´ ë‹«í˜€ìˆì„ ë•Œë§Œ ì¹´ìš´íŠ¸ ì¦ê°€
            if (chatPanel.style.display === 'none') {
                incrementChatBadge();

                // ì „ì²´í™”ë©´ì¼ ë•Œ ë©”ì‹œì§€ê°€ ë„ì°©í•˜ë©´ FAB í‘œì‹œ
                if (isFullscreen && unreadMessageCount > 0) {
                    chatFab.classList.add('has-messages');
                }
            }

            // ì „ì²´í™”ë©´ì¼ ë•ŒëŠ” ì¶”ê°€ ì•Œë¦¼ ì—†ì´ FABë§Œ í‘œì‹œ
            if (isFullscreen) {
                return;
            }
        }
    </script>
</body>
</html>
